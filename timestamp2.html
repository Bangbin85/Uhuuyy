<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bangbin Timestamp Tipu</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Memuat CSS Leaflet versi 1.7.1 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="icon" type="image/x-icon" href="https://lh3.googleusercontent.com/d/1_4llqCMNoBDmwDHsI7RYsCM6rSK5wEjw">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        #captureBtn {
            border: 4px solid white;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2), 0 0 0 4px rgba(255, 255, 255, 0.3);
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #captureBtn:active {
            transform: scale(0.92);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2), 0 0 0 2px rgba(255, 255, 255, 0.2);
        }
        @keyframes flash { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
        .flash-effect { animation: flash 0.5s ease-out; }
        #infoOverlay p {
            font-weight: bold;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 1);
            margin: 0;
            line-height: 1.25; /* Jarak antar baris yang lebih rapat */
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.hidden {
            opacity: 0;
            visibility: hidden;
        }
        /* Animasi saat marker ditambahkan (opsional) */
        .leaflet-marker-pane .leaflet-marker-icon {
            animation: bounceIn 0.8s ease-out;
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }
            50% {
                transform: scale(1.05);
                opacity: 1;
            }
            70% {
                transform: scale(0.9);
                }
            100% {
                transform: scale(1);
            }
        }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen text-white overflow-hidden">

    <div class="w-full max-w-lg h-dvh md:h-auto md:max-h-[90vh] bg-black rounded-lg shadow-2xl flex flex-col relative overflow-hidden">
        
        <div id="loadingMessage" class="absolute inset-0 bg-black bg-opacity-80 flex flex-col items-center justify-center z-50 transition-opacity duration-300">
            <svg id="loadingIcon" class="animate-spin text-5xl text-blue-400" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256"><path d="M232,128a104,104,0,0,1-208,0c0-41.21,24-76.3,58.74-92.65a8,8,0,0,1,8.52,13.3,88,88,0,1,0,81.48,0,8,8,0,0,1,8.52-13.3C208,51.7,232,86.79,232,128Z"></path></svg>
            <p id="loadingText" class="mt-4 text-lg text-center px-4">Membuka kamera...</p>
        </div>

        <div id="flashOverlay" class="absolute inset-0 bg-white z-40 pointer-events-none opacity-0"></div>

        <div id="cameraView" class="flex flex-col h-full">
            <header class="p-4 flex justify-between items-center bg-gray-900 bg-opacity-50 z-20">
                <div class="w-9 h-9"></div>
                <h1 class="text-xl font-bold">Uhuuyy</h1>
                <button id="profileBtn" class="text-white/80 hover:text-white transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" fill="currentColor" viewBox="0 0 256 256"><path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24ZM74.08,197.5a64.06,64.06,0,0,1,107.84,0,87.83,87.83,0,0,1-107.84,0ZM96,120a32,32,0,1,1,32,32A32,32,0,0,1,96,120Zm97.76,66.41a79.66,79.66,0,0,0-49.84-44.49,48,48,0,1,0-59.84,0,79.66,79.66,0,0,0-49.84,44.49,88,88,0,1,1,159.52,0Z"></path></svg>
                </button>
            </header>
            
            <main class="relative flex-grow flex items-center justify-center bg-black">
                <video id="videoFeed" class="w-full h-full object-cover" playsinline autoplay muted></video>
                <div id="infoOverlay" class="absolute bottom-0 left-0 w-full px-4 pt-4 pb-36 text-white pointer-events-none z-10"></div>
            </main>

            <footer class="absolute bottom-0 left-0 w-full p-4 z-20">
                <div class="w-full max-w-sm mx-auto p-2 bg-black bg-opacity-40 rounded-2xl flex items-center justify-between shadow-lg backdrop-blur-sm">
                    <div class="flex-1 flex justify-center">
                        <button id="editLocationBtn" class="text-white/80 hover:text-white transition p-3 rounded-full hover:bg-white/10">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 256 256"><path d="M128,64a40,40,0,1,0,40,40A40,40,0,0,0,128,64Zm0,64a24,24,0,1,1,24-24A24,24,0,0,1,128,128Zm0-112A88,88,0,0,0,40,104c0,72,80,144,88,152a8,8,0,0,0,16,0c8-8,88-80,88-152A88,88,0,0,0,128,16Zm0,208c-27.15-26.66-72-87.5-72-120a72,72,0,0,1,144,0C200,104.5,155.15,197.34,128,224Z"></path></svg>
                        </button>
                    </div>
                    <div class="flex-none">
                        <button id="captureBtn" class="w-20 h-20 bg-blue-500 rounded-full focus:outline-none"></button>
                    </div>
                    <div class="flex-1 flex justify-center">
                        <!-- Tombol untuk memilih gambar dari file -->
                        <input type="file" id="fileInput" accept="image/*" class="hidden">
                        <button id="selectFileBtn" class="text-white/80 hover:text-white transition p-3 rounded-full hover:bg-white/10">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 256 256"><path d="M216,40H88a8,8,0,0,0-8,8V72H40a8,8,0,0,0-8,8V216a8,8,0,0,0,8,8H168a8,8,0,0,0,8-8V184h32a8,8,0,0,0,8-8V48A8,8,0,0,0,216,40ZM160,208H48V88H80v96a8,8,0,0,0,8,8H160Zm48-48H176V80a8,8,0,0,0-8-8H96V48h112Z"></path></svg>
                        </button>
                        <!-- Tombol untuk mengganti kamera (hanya terlihat jika kamera aktif) -->
                        <button id="switchCameraBtn" class="text-white/80 hover:text-white transition p-3 rounded-full hover:bg-white/10">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 256 256"><path d="M232,96a8,8,0,0,1-8,8H175.31a80,80,0,0,1-142.62,0H24a8,8,0,0,1,0-16H80a8,8,0,0,1,7.92,6.66A64,64,0,0,1,215.3,86.42L227.88,73.85A8,8,0,0,1,240.12,86.12l-24,24A8,8,0,0,1,208,112a8,8,0,0,1-5.88-2.12L180.27,90.4a8,8,0,1,1,11.46-11.13L204.69,92A64.09,64.09,0,0,0,88,88a8,8,0,0,1,7.92-6.66,80,80,0,0,1,142.62,0H224A8,8,0,0,1,232,96Z"></path></svg>
                        </button>
                    </div>
                </div>
            </footer>
        </div>

        <div id="resultView" class="hidden flex-col h-full">
            <header class="p-4 text-center bg-gray-900"><h1 class="text-xl font-bold">Hasil Foto</h1></header>
            <main class="relative flex-grow flex items-center justify-center bg-black p-4 overflow-y-auto">
                <img id="resultImage" class="max-w-full max-h-full rounded-lg shadow-lg" alt="Hasil foto">
            </main>
            <footer class="p-4 grid grid-cols-2 gap-4 bg-gray-900">
                <button id="retakeBtn" class="w-full flex items-center justify-center gap-2 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M232,96a8,8,0,0,1-8,8H175.31a80,80,0,0,1-142.62,0H24a8,8,0,0,1,0-16H80a8,8,0,0,1,7.92,6.66A64,64,0,0,1,215.3,86.42L227.88,73.85A8,8,0,0,1,240.12,86.12l-24,24A8,8,0,0,1,208,112a8,8,0,0,1-5.88-2.12L180.27,90.4a8,8,0,1,1,11.46-11.13L204.69,92A64.09,64.09,0,0,0,88,88a8,8,0,0,1,7.92-6.66,80,80,0,0,1,142.62,0H224A8,8,0,0,1,232,96Z"></path></svg><span>Ulangi</span></button>
                <a id="downloadLink" href="#" download="foto-timestamp.png" class="w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg transition no-underline"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M213.66,122.34a8,8,0,0,1,0,11.32l-80,80a8,8,0,0,1-11.32-11.32L196.69,128,122.34,53.66a8,8,0,0,1,11.32-11.32l80,80ZM40,216H136a8,8,0,0,0,0-16H40a8,8,0,0,0,0,16Z"></path></svg><span>Unduh</span></a>
            </footer>
        </div>

        <canvas id="canvas" class="hidden"></canvas>

        <!-- Mini-Map Overlay -->
        <div id="miniMapContainer" class="hidden absolute top-4 right-4 z-30 bg-black bg-opacity-70 rounded-lg p-1 shadow-lg" style="width: 120px; height: 120px;">
            <div id="miniMap" class="w-full h-full rounded-md"></div>
        </div>
    </div>

    <!-- Modal Lokasi Baru -->
    <div id="locationModal" class="modal hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-lg md:max-w-3xl max-h-[90vh] overflow-y-auto"> <!-- Added max-h and overflow-y-auto -->
            <h2 class="text-xl font-bold mb-4">Edit Lokasi & Koordinat</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Bagian Kiri: Peta -->
                <div class="flex flex-col">
                    <h3 class="text-lg font-semibold mb-2">Pilih Lokasi di Peta</h3>
                    <div id="map" class="w-full" style="height: 350px; border-radius: 0.5rem; overflow: hidden;"></div> <!-- Map div -->
                </div>
                <!-- Bagian Kanan: Informasi Lokasi Input Fields -->
                <div>
                    <h3 class="text-lg font-semibold mb-2">Informasi Lokasi</h3>
                    <div class="space-y-3">
                        <input type="text" id="latitudeInput" placeholder="Latitude" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
                        <input type="text" id="longitudeInput" placeholder="Longitude" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
                        <input type="text" id="streetInput" placeholder="Nama Jalan" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
                        <input type="text" id="subDistrictInput" placeholder="Kecamatan" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
                        <input type="text" id="cityInput" placeholder="Kota" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
                        <input type="text" id="provinceInput" placeholder="Provinsi" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-4">
                <button id="closeLocationModalBtn" class="bg-gray-600 hover:bg-gray-500 font-bold py-2 px-4 rounded transition">Batal</button>
                <button id="saveLocationBtn" class="bg-blue-600 hover:bg-blue-500 font-bold py-2 px-4 rounded transition">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Modal Profil yang diperbarui -->
    <div id="profileModal" class="modal hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm max-h-[90vh] overflow-y-auto"> <!-- Added max-h and overflow-y-auto -->
            <h2 class="text-xl font-bold mb-4">Profil Pengguna</h2>
            <div class="space-y-4">
                <input type="text" id="nameInput" placeholder="Nama Lengkap" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
                <input type="text" id="nrkInput" placeholder="NRK" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
                <input type="date" id="profileDateInput" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
                <input type="time" id="profileTimeInput" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
            </div>
            <div class="mt-6 flex justify-end gap-4">
                <button id="closeProfileModalBtn" class="bg-gray-600 hover:bg-gray-500 font-bold py-2 px-4 rounded transition">Batal</button>
                <button id="saveProfileBtn" class="bg-blue-600 hover:bg-blue-500 font-bold py-2 px-4 rounded transition">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Memuat JavaScript Leaflet versi 1.7.1 -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // --- Seleksi Elemen DOM ---
        const video = document.getElementById('videoFeed');
        const captureBtn = document.getElementById('captureBtn');
        const switchCameraBtn = document.getElementById('switchCameraBtn');
        const canvas = document.getElementById('canvas');
        const downloadLink = document.getElementById('downloadLink');
        const resultImage = document.getElementById('resultImage');
        const retakeBtn = document.getElementById('retakeBtn');
        const cameraView = document.getElementById('cameraView');
        const resultView = document.getElementById('resultView');
        const loadingMessage = document.getElementById('loadingMessage');
        const flashOverlay = document.getElementById('flashOverlay');
        const infoOverlay = document.getElementById('infoOverlay');
        const context = canvas.getContext('2d');

        // Modal Profil
        const profileBtn = document.getElementById('profileBtn');
        const profileModal = document.getElementById('profileModal');
        const nameInput = document.getElementById('nameInput');
        const nrkInput = document.getElementById('nrkInput');
        const profileDateInput = document.getElementById('profileDateInput'); // Input tanggal baru
        const profileTimeInput = document.getElementById('profileTimeInput'); // Input jam baru
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        const closeProfileModalBtn = document.getElementById('closeProfileModalBtn');

        // Modal Lokasi
        const editLocationBtn = document.getElementById('editLocationBtn');
        const locationModal = document.getElementById('locationModal');       
        const streetInput = document.getElementById('streetInput');
        const subDistrictInput = document.getElementById('subDistrictInput');
        const cityInput = document.getElementById('cityInput');
        const provinceInput = document.getElementById('provinceInput');
        const latitudeInput = document.getElementById('latitudeInput');
        const longitudeInput = document.getElementById('longitudeInput');
        const saveLocationBtn = document.getElementById('saveLocationBtn');
        const closeLocationModalBtn = document.getElementById('closeLocationModalBtn');

        // Input File
        const fileInput = document.getElementById('fileInput');
        const selectFileBtn = document.getElementById('selectFileBtn');

        // --- State Aplikasi ---
        let userProfile = { 
            name: '', 
            nrk: '', 
            date: '', // Tanggal dari profil
            time: ''  // Waktu dari profil
        };
        // locationData sekarang menyimpan nilai numerik untuk lat/lon
        let locationData = {
            latitude: -6.175,  // Nilai default numerik
            longitude: 106.828, // Nilai default numerik
            street: 'No.5 Jalan Medan Merdeka Selatan',
            subDistrict: 'Kecamatan Gambir',
            city: 'Kota Jakarta Pusat',
            province: 'Daerah Khusus Ibukota Jakarta'
        };
        let currentStream;
        let currentFacingMode = 'environment';
        let isCameraActive = false; // Menandakan apakah kamera sedang aktif

        // --- Variabel Peta Leaflet ---
        let map; // Untuk peta utama di modal
        let marker = null;
        let mapInitialized = false; // Flag untuk memastikan peta utama hanya diinisialisasi sekali

        // --- Variabel Mini-Map ---
        const miniMapContainer = document.getElementById('miniMapContainer');
        let miniMap;
        let miniMapMarker = null;
        let miniMapInitialized = false; // Flag untuk memastikan mini-map hanya diinisialisasi sekali


        // --- Fungsi Utama ---
        async function initialize() {
            try {
                // Mencoba memulai kamera secara default
                await startCamera(currentFacingMode);
                isCameraActive = true;
                // Menampilkan tombol ganti kamera
                switchCameraBtn.classList.remove('hidden');
            } catch (error) {
                // Jika kamera gagal, sembunyikan tombol ganti kamera
                switchCameraBtn.classList.add('hidden');
                isCameraActive = false;
                // Tetap tampilkan pesan jika kamera gagal diakses
                const loadingIcon = document.getElementById('loadingIcon');
                loadingIcon.outerHTML = '<svg id="loadingIcon" class="text-5xl text-red-400" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 256 256"><path d="M128,24a104,104,0,1,0,104,104A104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm-8-40V120a8,8,0,0,1,16,0v56a8,8,0,0,1-16,0Zm-2.2-86.18a12,12,0,1,1,12,12.06A12,12,0,0,1,117.8,89.82Z"></path></svg>';
                document.getElementById('loadingText').innerHTML = `Error: ${error.message}<br>Pastikan Anda memberikan izin kamera atau gunakan fitur "Pilih Gambar".`;
            } finally {
                updateInfo();
                loadingMessage.classList.add('opacity-0');
                setTimeout(() => loadingMessage.classList.add('hidden'), 300);

                // Inisialisasi mini-map jika ada data lokasi default
                if (!isNaN(locationData.latitude) && !isNaN(locationData.longitude)) {
                    updateMiniMapDisplay(locationData.latitude, locationData.longitude);
                }
            }
        }
        
        function startCamera(facingMode) {
            return new Promise(async (resolve, reject) => {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: { ideal: facingMode }, width: { ideal: 1920 }, height: { ideal: 1080 } },
                        audio: false
                    });
                    video.srcObject = stream;
                    currentStream = stream;
                    isCameraActive = true;
                    video.onloadedmetadata = () => resolve();
                } catch (err) { 
                    isCameraActive = false;
                    reject(new Error("Gagal mengakses kamera.")); 
                }
            });
        }
        
        async function switchCamera() {
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            loadingMessage.classList.remove('hidden', 'opacity-0');
            document.getElementById('loadingText').textContent = 'Mengganti kamera...';
            try {
                await startCamera(currentFacingMode);
            } catch (error) {
                document.getElementById('loadingText').innerHTML = `Error: ${error.message}`;
            } finally {
                loadingMessage.classList.add('opacity-0');
                setTimeout(() => loadingMessage.classList.add('hidden'), 300);
            }
        }

        // Fungsi untuk memformat koordinat numerik ke string tampilan
        function formatCoordinateForDisplay(value, type) {
            if (typeof value !== 'number' || isNaN(value)) {
                return 'N/A'; // Fallback
            }
            const sign = value < 0 ? (type === 'lat' ? 'S' : 'N') : (type === 'lat' ? 'N' : 'E');
            return `${Math.abs(value).toFixed(6)}${sign}`;
        }

        function getInfoLines() {
            let displayDateTime;
            if (userProfile.date && userProfile.time) {
                // Gunakan tanggal dan jam dari profil jika diatur
                const profileDate = new Date(`${userProfile.date}T${userProfile.time}`);
                displayDateTime = formatDateTime(profileDate);
            } else {
                // Fallback ke tanggal dan jam sistem saat ini
                displayDateTime = formatDateTime(new Date());
            }

            const lines = [
                `Network : ${displayDateTime}`,
                `Local   : ${displayDateTime}`,
                `${formatCoordinateForDisplay(locationData.latitude, 'lat')} ${formatCoordinateForDisplay(locationData.longitude, 'lon')}`,
                locationData.street,
                locationData.subDistrict,
                locationData.city,
                locationData.province
            ];
            if (userProfile.name) lines.push(userProfile.name);
            if (userProfile.nrk) lines.push(userProfile.nrk);
            return lines;
        }

        function updateInfo() {
            infoOverlay.innerHTML = '';
            // Gunakan video.offsetWidth hanya jika kamera aktif, jika tidak gunakan resultImage.offsetWidth
            const referenceElement = isCameraActive ? video : resultImage;
            const elementWidth = referenceElement.offsetWidth || referenceElement.clientWidth;
            const fontSize = Math.floor(elementWidth / 28);
            getInfoLines().forEach(line => {
                const p = document.createElement('p');
                p.textContent = line;
                p.style.fontSize = `${fontSize}px`;
                infoOverlay.appendChild(p);
            });
        }

        function captureImage(sourceImage) {
            flashOverlay.classList.add('flash-effect');
            setTimeout(() => flashOverlay.classList.remove('flash-effect'), 500);

            let imageToDraw = sourceImage || video;

            canvas.width = imageToDraw.videoWidth || imageToDraw.naturalWidth;
            canvas.height = imageToDraw.videoHeight || imageToDraw.naturalHeight;
            
            context.clearRect(0, 0, canvas.width, canvas.height);

            if (imageToDraw === video && currentFacingMode === 'user') {
                context.save();
                context.scale(-1, 1);
                context.drawImage(imageToDraw, -canvas.width, 0, canvas.width, canvas.height);
                context.restore();
            } else {
                context.drawImage(imageToDraw, 0, 0, canvas.width, canvas.height);
            }

            const infoLines = getInfoLines();
            const fontSize = Math.floor(canvas.width / 20);
            const padding = fontSize * 1.5;
            const lineHeight = fontSize * 1.25;
            
            context.font = `bold ${fontSize}px 'Inter', sans-serif`;
            context.textAlign = 'left';
            context.fillStyle = 'white';
            context.shadowColor = 'rgba(0, 0, 0, 1)';
            context.shadowBlur = 5;
            context.shadowOffsetX = 2;
            context.shadowOffsetY = 2;
            
            // Menyesuaikan footerClearance: minimum 30px atau 10% tinggi canvas, mana yang lebih besar
            const footerClearance = Math.max(30, canvas.height * 0.02); 
            infoLines.forEach((line, index) => {
                const y = canvas.height - footerClearance - ((infoLines.length - 1 - index) * lineHeight);
                context.fillText(line, padding, y);
            });
            
            const imageDataUrl = canvas.toDataURL('image/jpeg', 0.9);

            resultImage.src = imageDataUrl; // Set the src first

            // Wait for the resultImage to load before showing the view and updating info
            resultImage.onload = () => {
                downloadLink.href = imageDataUrl;
                downloadLink.download = `foto_${new Date().toISOString()}.jpeg`;
                showResultView(); // This will call updateInfo()
                resultImage.onload = null; // Clear the handler to prevent re-execution
            };

            // If the image is already cached or loads very quickly, onload might not fire.
            // Check if it's already complete.
            if (resultImage.complete && resultImage.naturalWidth !== 0) {
                resultImage.onload(); // Manually trigger if already loaded
            }
        }
        
        function showResultView() {
            // Hentikan kamera jika sedang aktif
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                isCameraActive = false;
            }
            cameraView.classList.add('hidden');
            resultView.classList.remove('hidden');
            resultView.classList.add('flex');
            // Sembunyikan tombol switch kamera saat di tampilan hasil
            switchCameraBtn.classList.add('hidden');
            updateInfo(); // Perbarui info overlay untuk gambar hasil
        }

        function formatDateTime(date) {
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            const datePart = date.toLocaleDateString('id-ID', options);
            const timePart = date.toLocaleTimeString('id-ID', { hour12: false }).replace(/\./g, '.');
            return `${datePart} ${timePart} WIB`;
        }

        // --- Fungsi Leaflet Map Utama (di modal) ---
        function initMap() {
            if (mapInitialized) {
                map.invalidateSize(); // Pastikan peta di-render ulang jika sudah ada
                return;
            }
            // Inisialisasi peta
            // Set tampilan awal peta ke Jakarta, Indonesia dengan zoom level 13
            map = L.map('map').setView([-6.2088, 106.8456], 13); // Jakarta sebagai pusat awal

            // Tambahkan layer peta dari OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Event listener ketika peta diklik
            map.on('click', async function(e) {
                const { lat, lng } = e.latlng; // Mendapatkan latitude dan longitude dari objek event
                
                // Set teks "Mendapatkan..." pada semua elemen alamat saat proses dimulai
                latitudeInput.value = "Mendapatkan...";
                longitudeInput.value = "Mendapatkan...";
                streetInput.value = "Mendapatkan...";
                subDistrictInput.value = "Mendapatkan...";
                cityInput.value = "Mendapatkan...";
                provinceInput.value = "Mendapatkan...";
                
                // Dapatkan detail alamat secara asinkron
                const addressDetails = await getAddressDetails(lat, lng);

                // Hapus marker yang ada sebelumnya (jika ada)
                if (marker) {
                    map.removeLayer(marker);
                }
                
                if (addressDetails.error) {
                    latitudeInput.value = lat.toFixed(6);
                    longitudeInput.value = lng.toFixed(6);
                    streetInput.value = addressDetails.error;
                    subDistrictInput.value = "-";
                    cityInput.value = "-";
                    provinceInput.value = "-";
                } else {
                    // Perbarui input dengan detail alamat
                    latitudeInput.value = `${lat.toFixed(6)}${lat < 0 ? 'S' : 'N'}`; // Format koordinat
                    longitudeInput.value = `${lng.toFixed(6)}${lng < 0 ? 'W' : 'E'}`; // Format koordinat
                    streetInput.value = addressDetails.jalan;
                    subDistrictInput.value = addressDetails.kecamatan;
                    cityInput.value = addressDetails.kota;
                    provinceInput.value = addressDetails.provinsi;
                }
                
                // Tambahkan marker baru di lokasi klik dan kaitkan popup
                marker = L.marker([lat, lng]).addTo(map)
                    .bindPopup(`<b>Koordinat:</b><br>${lat.toFixed(6)}, ${lng.toFixed(6)}<br><b>Alamat:</b><br>${addressDetails.jalan || "Alamat tidak tersedia"}`) 
                    .openPopup(); // Langsung buka popup
            });
            mapInitialized = true;
        }

        // Fungsi inisialisasi dan pembaruan Mini-Map
        function updateMiniMapDisplay(lat, lon) {
            if (!miniMapInitialized) {
                // Inisialisasi mini-map jika belum ada
                miniMap = L.map('miniMap', {
                    zoomControl: false, // Tidak ada kontrol zoom
                    attributionControl: false, // Tidak ada atribusi
                    dragging: false, // Tidak bisa digeser
                    touchZoom: false, // Tidak bisa di-zoom dengan sentuhan
                    scrollWheelZoom: false, // Tidak bisa di-zoom dengan scroll mouse
                    doubleClickZoom: false, // Tidak bisa di-zoom double klik
                    boxZoom: false, // Tidak ada box zoom
                    keyboard: false, // Tidak bisa dikendalikan keyboard
                    tap: false, // Tidak ada tap event
                    minZoom: 13, // Batasi zoom
                    maxZoom: 13, // Batasi zoom
                }).setView([lat, lon], 13);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '' // Atribusi kosong untuk mini map
                }).addTo(miniMap);
                miniMapInitialized = true;
            }

            miniMap.setView([lat, lon], 13); // Selalu set tampilan ke koordinat terbaru

            if (miniMapMarker) {
                miniMapMarker.setLatLng([lat, lon]); // Perbarui posisi marker yang ada
            } else {
                miniMapMarker = L.marker([lat, lon]).addTo(miniMap); // Tambahkan marker baru
            }
            
            // Pastikan mini-map terlihat
            miniMapContainer.classList.remove('hidden');
            miniMap.invalidateSize(); // Penting agar mini-map dirender dengan benar
        }

        // Fungsi asinkron untuk mendapatkan detail alamat dari koordinat menggunakan Nominatim API
        async function getAddressDetails(lat, lng) {
            try {
                // Menggunakan addressdetails=1 untuk mendapatkan detail alamat yang lebih kaya
                // dan zoom=18 untuk detail yang lebih spesifik pada tingkat jalan
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                const data = await response.json();
                
                if (data.error) {
                    return { error: "Alamat tidak ditemukan" };
                }
                
                // Ekstrak komponen alamat dari objek 'address' di respons Nominatim
                const address = data.address || {};
                const displayAddress = data.display_name || "Alamat tidak tersedia";

                // Menentukan nilai 'provinsi' dengan beberapa fallback dan prioritas DKI Jakarta
                let provinsi = 'Tidak tersedia';
                if (displayAddress.includes('Daerah Khusus Ibukota Jakarta') ||
                    (address.city && address.city.includes('Jakarta')) ||
                    (address.state_district && address.state_district.includes('Jakarta'))
                ) {
                    provinsi = 'Daerah Khusus Ibukota Jakarta';
                } else if (address.state) {
                    provinsi = address.state;
                } else if (address.state_district) {
                    provinsi = address.state_district;
                } else if (address.county) {
                    provinsi = address.county;
                }

                // Membangun "Jalan" agar lebih lengkap (hingga RT/RW jika ada)
                let jalanLengkap = address.road || '';
                if (address.house_number) {
                    jalanLengkap += `, No. ${address.house_number}`;
                }

                // Pola regex untuk mencari RT/RW. Ini mencari "RT" atau "RW" diikuti angka, dengan atau tanpa "/" dan spasi.
                const rtRwPattern = /(?:RT\s*\d{1,3}(?:\s*[\/\-]\s*RW\s*\d{1,3})?|RW\s*\d{1,3}(?:\s*[\/\-]\s*RT\s*\d{1,3})?)/i;
                
                const displayParts = displayAddress.split(',');
                let rtRwFound = '';
                for (const part of displayParts) {
                    const match = part.trim().match(rtRwPattern);
                    if (match) {
                        rtRwFound = match[0].trim();
                        break;
                    }
                }

                if (rtRwFound && !jalanLengkap.includes(rtRwFound)) {
                    // Hanya tambahkan jika belum ada di jalanLengkap
                    jalanLengkap += (jalanLengkap ? ', ' : '') + rtRwFound;
                }
                
                jalanLengkap = jalanLengkap || 'Tidak tersedia'; // Pastikan tidak kosong

                return {
                    jalan: jalanLengkap, 
                    kecamatan: address.suburb || address.village || 'Tidak tersedia',
                    kota: address.city || address.town || address.county || 'Tidak tersedia',
                    provinsi: provinsi,
                    postcode: address.postcode || 'Tidak tersedia',
                };

            } catch (error) {
                console.error("Error saat mendapatkan detail alamat:", error);
                return { error: `Gagal mendapatkan alamat: ${error.message}` };
            }
        }


        // --- Event Listeners ---
        captureBtn.addEventListener('click', () => {
            if (isCameraActive) { // Hanya izinkan capture jika kamera aktif
                captureImage(video);
            } else if (resultImage.src && resultView.classList.contains('flex')) {
                // Jika sudah ada gambar di resultView (dari file), izinkan untuk distamp lagi
                // Namun, ini bukan "capture" baru, melainkan stamping ulang gambar yang sudah ada
                captureImage(resultImage); 
            }
            // Jika tidak ada kamera aktif dan tidak ada gambar di resultView, tidak melakukan apa-apa (tidak ada alert)
        });

        switchCameraBtn.addEventListener('click', switchCamera);
        
        retakeBtn.addEventListener('click', () => {
             cameraView.classList.remove('hidden');
             resultView.classList.add('hidden');
             initialize(); // Inisialisasi ulang kamera saat "Ulangi"
        });
        window.addEventListener('resize', updateInfo);

        // Modal Profil Listeners
        profileBtn.addEventListener('click', () => {
            // Isi input dengan nilai profil yang ada
            nameInput.value = userProfile.name;
            nrkInput.value = userProfile.nrk;

            // Set default date/time to current if not already set
            const now = new Date();
            const defaultDate = now.toISOString().split('T')[0]; // Format YYYY-MM-DD
            const defaultTime = now.toTimeString().slice(0, 5); // Format HH:MM

            profileDateInput.value = userProfile.date || defaultDate;
            profileTimeInput.value = userProfile.time || defaultTime;
            
            profileModal.classList.remove('hidden');
        });
        closeProfileModalBtn.addEventListener('click', () => profileModal.classList.add('hidden'));
        saveProfileBtn.addEventListener('click', () => {
            userProfile.name = nameInput.value.trim();
            userProfile.nrk = nrkInput.value.trim();
            userProfile.date = profileDateInput.value;
            userProfile.time = profileTimeInput.value;
            profileModal.classList.add('hidden');
            updateInfo(); // Perbarui overlay setelah menyimpan profil
        });

        // Modal Lokasi Listeners
        editLocationBtn.addEventListener('click', () => {
            // Isi input dengan nilai lokasi yang ada
            latitudeInput.value = formatCoordinateForDisplay(locationData.latitude, 'lat');
            longitudeInput.value = formatCoordinateForDisplay(locationData.longitude, 'lon');
            streetInput.value = locationData.street;
            subDistrictInput.value = locationData.subDistrict;
            cityInput.value = locationData.city;
            provinceInput.value = locationData.province;
            locationModal.classList.remove('hidden');
            initMap(); // Inisialisasi peta utama saat modal dibuka
        });
        closeLocationModalBtn.addEventListener('click', () => {
            locationModal.classList.add('hidden');
            // Pastikan peta utama me-refresh ukuran setelah modal ditutup (jika visiblenya berubah)
            if (mapInitialized) {
                map.invalidateSize();
            }
        });
        saveLocationBtn.addEventListener('click', () => {
            // Parse latitude and longitude from input.value, strip S/N/E/W first
            let latStr = latitudeInput.value.replace(/[SN]/g, '');
            let lonStr = longitudeInput.value.replace(/[WE]/g, '');

            let latVal = parseFloat(latStr);
            let lonVal = parseFloat(lonStr);

            // Apply negative sign if S or W was present in original string
            if (latitudeInput.value.includes('S')) latVal = -Math.abs(latVal);
            if (longitudeInput.value.includes('W')) lonVal = -Math.abs(lonVal);

            locationData.latitude = isNaN(latVal) ? -6.175 : latVal; // Use initial default if parsing fails
            locationData.longitude = isNaN(lonVal) ? 106.828 : lonVal; // Use initial default if parsing fails
            locationData.street = streetInput.value.trim();
            locationData.subDistrict = subDistrictInput.value.trim();
            locationData.city = cityInput.value.trim();
            locationData.province = provinceInput.value.trim();
            
            updateMiniMapDisplay(locationData.latitude, locationData.longitude); // Perbarui mini map
            locationModal.classList.add('hidden');
            updateInfo(); // Perbarui overlay setelah menyimpan lokasi
        });

        // Listener untuk tombol "Pilih Gambar"
        selectFileBtn.addEventListener('click', () => fileInput.click());

        // Listener saat file dipilih
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        captureImage(img); // Panggil captureImage dengan gambar dari file
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>

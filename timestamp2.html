<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bangbin Timestamp</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
	<link rel="icon" type="image/x-icon" href="https://lh3.googleusercontent.com/d/1_4llqCMNoBDmwDHsI7RYsCM6rSK5wEjw">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        #captureBtn {
            border: 4px solid white;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2), 0 0 0 4px rgba(255, 255, 255, 0.3);
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #captureBtn:active {
            transform: scale(0.92);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2), 0 0 0 2px rgba(255, 255, 255, 0.2);
        }
        @keyframes flash { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
        .flash-effect { animation: flash 0.5s ease-out; }
        #infoOverlay p {
            font-weight: bold;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 1);
            margin: 0;
            line-height: 1.4;
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.hidden {
            opacity: 0;
            visibility: hidden;
        }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen text-white overflow-hidden p-4">

    <div class="w-full max-w-lg md:max-w-2xl lg:max-w-4xl h-dvh md:h-auto md:max-h-[90vh] bg-black rounded-lg shadow-2xl flex flex-col relative overflow-hidden">
        
        <div id="loadingMessage" class="absolute inset-0 bg-black bg-opacity-80 flex flex-col items-center justify-center z-50 transition-opacity duration-300">
            <i id="loadingIcon" class="fa-solid fa-spinner fa-spin text-5xl text-blue-400"></i>
            <p id="loadingText" class="mt-4 text-lg text-center px-4">Membuka kamera...</p>
        </div>

        <div id="flashOverlay" class="absolute inset-0 bg-white z-40 pointer-events-none opacity-0"></div>

        <div id="cameraView" class="relative h-full">
            <main class="absolute inset-0 flex items-center justify-center bg-black">
                <video id="videoFeed" class="w-full h-full object-cover" playsinline autoplay muted></video>
                <div id="infoOverlay" class="absolute bottom-0 left-0 w-full p-4 text-white pointer-events-none z-10"></div>
            </main>

            <header class="absolute top-0 left-0 w-full p-4 flex justify-between items-center bg-gradient-to-b from-black/60 to-transparent z-20">
                <h1 class="text-xl font-bold">Uhuuyy</h1>
                <button id="profileBtn" class="text-white/80 hover:text-white transition">
                    <i class="fa-solid fa-user text-3xl"></i>
                </button>
            </header>
            
            <footer class="absolute bottom-0 left-0 w-full p-4 flex items-center justify-between bg-gradient-to-t from-black/60 to-transparent z-20">
                <button id="editTimeBtn" class="text-white/80 hover:text-white transition">
                    <i class="fa-solid fa-calendar-days text-3xl"></i>
                </button>
                <button id="captureBtn" class="w-20 h-20 bg-blue-500 rounded-full focus:outline-none"></button>
                <button id="switchCameraBtn" class="text-white/80 hover:text-white transition">
                    <i class="fa-solid fa-camera-rotate text-3xl"></i>
                </button>
            </footer>
        </div>

        <div id="resultView" class="hidden flex-col h-full">
            <header class="p-4 text-center bg-gray-900"><h1 class="text-xl font-bold">Hasil Foto</h1></header>
            <main class="relative flex-grow flex items-center justify-center bg-black p-4">
                <img id="resultImage" class="max-w-full max-h-full rounded-lg shadow-lg" alt="Hasil foto">
            </main>
            <footer class="p-4 grid grid-cols-2 gap-4 bg-gray-900">
                <button id="retakeBtn" class="w-full flex items-center justify-center gap-2 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition">
                    <i class="fa-solid fa-arrows-rotate"></i>
                    <span>Ulangi</span>
                </button>
                <a id="downloadLink" href="#" download="foto-timestamp.png" class="w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg transition no-underline">
                    <i class="fa-solid fa-download"></i>
                    <span>Unduh</span>
                </a>
            </footer>
        </div>

        <canvas id="canvas" class="hidden"></canvas>
    </div>

    <div id="timeModal" class="modal hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Edit Waktu</h2>
            <input type="datetime-local" id="timeInput" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
            <div class="mt-6 flex justify-end gap-4">
                <button id="closeTimeModalBtn" class="bg-gray-600 hover:bg-gray-500 font-bold py-2 px-4 rounded transition">Batal</button>
                <button id="saveTimeBtn" class="bg-blue-600 hover:bg-blue-500 font-bold py-2 px-4 rounded transition">Simpan</button>
            </div>
        </div>
    </div>

    <div id="profileModal" class="modal hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Profil Pengguna</h2>
            <div class="space-y-4">
                <input type="text" id="nameInput" placeholder="Nama Lengkap" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
                <input type="text" id="nrkInput" placeholder="NRK" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
            </div>
            <div class="mt-6 flex justify-end gap-4">
                <button id="closeProfileModalBtn" class="bg-gray-600 hover:bg-gray-500 font-bold py-2 px-4 rounded transition">Batal</button>
                <button id="saveProfileBtn" class="bg-blue-600 hover:bg-blue-500 font-bold py-2 px-4 rounded transition">Simpan</button>
            </div>
        </div>
    </div>

    <script>
        // --- Seleksi Elemen DOM ---
        const video = document.getElementById('videoFeed');
        const captureBtn = document.getElementById('captureBtn');
        const switchCameraBtn = document.getElementById('switchCameraBtn');
        const canvas = document.getElementById('canvas');
        const downloadLink = document.getElementById('downloadLink');
        const resultImage = document.getElementById('resultImage');
        const retakeBtn = document.getElementById('retakeBtn');
        const cameraView = document.getElementById('cameraView');
        const resultView = document.getElementById('resultView');
        const loadingMessage = document.getElementById('loadingMessage');
        const flashOverlay = document.getElementById('flashOverlay');
        const infoOverlay = document.getElementById('infoOverlay');
        const context = canvas.getContext('2d');
        const profileBtn = document.getElementById('profileBtn');
        const profileModal = document.getElementById('profileModal');
        const nameInput = document.getElementById('nameInput');
        const nrkInput = document.getElementById('nrkInput');
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        const closeProfileModalBtn = document.getElementById('closeProfileModalBtn');
        const editTimeBtn = document.getElementById('editTimeBtn');
        const timeModal = document.getElementById('timeModal');
        const timeInput = document.getElementById('timeInput');
        const saveTimeBtn = document.getElementById('saveTimeBtn');
        const closeTimeModalBtn = document.getElementById('closeTimeModalBtn');

        // --- State Aplikasi ---
        let userProfile = { name: '', nrk: '' };
        let customTimestamp = '17 Agu 2025 16.42.37 WIB';
        let currentStream;
        let currentFacingMode = 'environment';

        // --- Fungsi Utama ---
        async function initialize() {
            try {
                await startCamera(currentFacingMode);
                updateInfo();
                loadingMessage.classList.add('opacity-0');
                setTimeout(() => loadingMessage.classList.add('hidden'), 300);
            } catch (error) {
                const loadingIcon = document.getElementById('loadingIcon');
                loadingIcon.className = 'fa-solid fa-circle-exclamation text-5xl text-red-400';
                document.getElementById('loadingText').innerHTML = `Error: ${error.message}<br>Pastikan Anda memberikan izin kamera.`;
            }
        }
        
        function startCamera(facingMode) {
            return new Promise(async (resolve, reject) => {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => {
                        track.stop();
                    });
                }
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: { ideal: facingMode }, width: { ideal: 1920 }, height: { ideal: 1080 } },
                        audio: false
                    });
                    video.srcObject = stream;
                    currentStream = stream;
                    video.onloadedmetadata = () => resolve();
                } catch (err) { reject(new Error("Gagal mengakses kamera.")); }
            });
        }
        
        async function switchCamera() {
            loadingMessage.classList.remove('hidden');
            loadingMessage.classList.remove('opacity-0');
            document.getElementById('loadingText').textContent = 'Mengganti kamera...';
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            try {
                await startCamera(currentFacingMode);
            } catch (error) {
                 document.getElementById('loadingText').innerHTML = `Error: ${error.message}`;
            } finally {
                loadingMessage.classList.add('opacity-0');
                setTimeout(() => loadingMessage.classList.add('hidden'), 300);
            }
        }

        function getInfoLines() {
            const lines = [
                `Network : ${customTimestamp}`,
                `Local   : ${customTimestamp}`,
                `6°10'46,945"S 106°49'33,621"E`,
                'No.5 Jalan Medan Merdeka Selatan',
                'Kecamatan Gambir',
                'Kota Jakarta Pusat',
                'Daerah Khusus Ibukota Jakarta'
            ];
            if (userProfile.name) lines.push(userProfile.name);
            if (userProfile.nrk) lines.push(userProfile.nrk);
            return lines;
        }

        function updateInfo() {
            infoOverlay.innerHTML = '';
            const elementWidth = video.offsetWidth || video.clientWidth;
            
            const baseSize = Math.floor(elementWidth / 38);
            const fontSize = Math.max(12, baseSize);

            const footer = document.querySelector('#cameraView footer');
            if (footer) {
                const footerHeight = footer.offsetHeight;
                infoOverlay.style.bottom = `${footerHeight}px`;
            }

            getInfoLines().forEach(line => {
                const p = document.createElement('p');
                p.textContent = line;
                p.style.fontSize = `${fontSize}px`;
                infoOverlay.appendChild(p);
            });
        }

        function captureImage() {
            flashOverlay.classList.add('flash-effect');
            setTimeout(() => flashOverlay.classList.remove('flash-effect'), 500);

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            if (currentFacingMode === 'user') {
                context.save();
                context.scale(-1, 1);
                context.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
                context.restore();
            } else {
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
            }

            const infoLines = getInfoLines();
            
            const baseSizeCanvas = Math.floor(canvas.width / 38);
            const fontSizeCanvas = Math.max(12, baseSizeCanvas);
            const padding = fontSizeCanvas * 1.5;
            const lineHeight = fontSizeCanvas * 1.4;
            
            context.font = `bold ${fontSizeCanvas}px 'Inter', sans-serif`;
            context.textAlign = 'left';
            context.fillStyle = 'white';
            context.shadowColor = 'rgba(0, 0, 0, 1)';
            context.shadowBlur = 5;
            context.shadowOffsetX = 2;
            context.shadowOffsetY = 2;

            infoLines.forEach((line, index) => {
                const y = canvas.height - padding - ((infoLines.length - 1 - index) * lineHeight);
                context.fillText(line, padding, y);
            });
            
            const imageDataUrl = canvas.toDataURL('image/jpeg', 0.9);

            resultImage.src = imageDataUrl;
            downloadLink.href = imageDataUrl;
            downloadLink.download = `foto_${new Date().toISOString()}.jpeg`;
            showResultView();
        }
        
        function showResultView() {
            cameraView.style.display = 'none';
            resultView.classList.remove('hidden');
            resultView.classList.add('flex');
        }

        function formatDateTime(date) {
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            const datePart = date.toLocaleDateString('id-ID', options);
            const timePart = date.toLocaleTimeString('id-ID', { hour12: false }).replace(/\./g, '.');
            return `${datePart} ${timePart} WIB`;
        }

        // --- Event Listeners ---
        captureBtn.addEventListener('click', captureImage);
        switchCameraBtn.addEventListener('click', switchCamera);
        retakeBtn.addEventListener('click', () => {
             resultView.classList.add('hidden');
             cameraView.style.display = 'block';
             resultView.classList.remove('flex');
        });
        window.addEventListener('resize', updateInfo);

        profileBtn.addEventListener('click', () => profileModal.classList.remove('hidden'));
        closeProfileModalBtn.addEventListener('click', () => profileModal.classList.add('hidden'));
        saveProfileBtn.addEventListener('click', () => {
            userProfile.name = nameInput.value.trim();
            userProfile.nrk = nrkInput.value.trim();
            profileModal.classList.add('hidden');
            updateInfo();
        });

        editTimeBtn.addEventListener('click', () => {
            const date = new Date('2025-08-17T16:42:37');
            timeInput.value = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}T${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
            timeModal.classList.remove('hidden');
        });
        closeTimeModalBtn.addEventListener('click', () => timeModal.classList.add('hidden'));
        saveTimeBtn.addEventListener('click', () => {
            if (timeInput.value) {
                const newDate = new Date(timeInput.value);
                customTimestamp = formatDateTime(newDate);
                timeModal.classList.add('hidden');
                updateInfo();
            }
        });

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>

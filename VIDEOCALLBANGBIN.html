<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Call Grup</title>
    <style>
        :root {
            --dark-bg: #222;
            --primary-accent: #007bff;
            --card-bg: #333;
            --light-text: #f0f0f0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--dark-bg);
            color: var(--light-text);
            margin: 0;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            box-sizing: border-box;
        }
        h1 {
            color: var(--primary-accent);
            text-align: center;
        }
        #video-grid {
            flex-grow: 1;
            width: 100%;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .video-container {
            position: relative;
            background-color: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Efek cermin untuk kamera depan */
        }
        .participant-name {
            position: absolute;
            bottom: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 0.3em 0.6em;
            margin: 0.5rem;
            border-radius: 4px;
            font-size: 0.9em;
        }
        #controls {
            padding: 1rem;
            background-color: var(--card-bg);
            border-radius: 8px;
        }
        button {
            background-color: var(--primary-accent);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>

    <h1>Video Call Grup</h1>
    <div id="video-grid"></div>
    <div id="controls">
        <button id="joinButton">Gabung ke Ruangan</button>
    </div>

<script>
    // === KONFIGURASI ===
    // Ini adalah satu-satunya alamat "luar" yang dibutuhkan.
    // Ini adalah alamat "papan pengumuman" publik dan gratis.
    const SIGNALING_SERVER_URL = 'wss://simple-webrtc-signaling-server.glitch.me';

    // Konfigurasi server STUN dari Google untuk membantu koneksi.
    const ICE_SERVERS = {
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    };

    // === ELEMEN PADA HALAMAN ===
    const joinButton = document.getElementById('joinButton');
    const videoGrid = document.getElementById('video-grid');
    
    // === VARIABEL GLOBAL ===
    let localStream;
    let myClientId;
    const peerConnections = {}; // Menyimpan semua koneksi ke user lain
    let signalingSocket;

    // === FUNGSI UTAMA ===

    joinButton.onclick = async () => {
        try {
            // 1. Dapatkan akses ke kamera dan mikrofon
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            displayVideo('Anda (Lokal)', localStream);

            // 2. Hubungi "papan pengumuman"
            connectToSignalingServer();
            
            joinButton.style.display = 'none'; // Sembunyikan tombol setelah bergabung
        } catch (err) {
            console.error("Error: Tidak bisa mengakses kamera/mikrofon.", err);
            alert("Gagal mengakses kamera. Mohon berikan izin pada browser Anda.");
        }
    };

    function connectToSignalingServer() {
        signalingSocket = new WebSocket(SIGNALING_SERVER_URL);
        
        const roomName = window.location.hash.substring(1) || 'ruang-publik';

        // Saat koneksi ke "papan pengumuman" berhasil
        signalingSocket.onopen = () => {
            console.log("Terhubung ke server signaling.");
            // Kirim pesan bahwa kita mau bergabung ke sebuah ruangan
            signalingSocket.send(JSON.stringify({ action: 'join', room: roomName }));
        };

        // Saat menerima pesan dari "papan pengumuman"
        signalingSocket.onmessage = handleSignalingMessage;

        signalingSocket.onclose = () => {
            console.warn("Koneksi ke server signaling terputus.");
        };
        signalingSocket.onerror = (err) => {
            console.error("Error pada server signaling:", err);
        };
    }

    async function handleSignalingMessage(message) {
        const msg = JSON.parse(message.data);

        switch (msg.action) {
            // Server memberi tahu ID unik kita
            case 'id':
                myClientId = msg.id;
                break;
            
            // Saat ada user BARU yang bergabung
            case 'user-joined':
                const newClientId = msg.id;
                console.log(`User baru bergabung: ${newClientId}`);
                // Buat koneksi baru untuk user tersebut
                const pc = createPeerConnection(newClientId);
                // Buat penawaran untuk memulai panggilan
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                // Kirim penawaran ke user baru melalui server
                sendSignal(newClientId, { type: 'offer', sdp: offer.sdp });
                break;
            
            // Saat ada user yang KELUAR
            case 'user-left':
                const leftClientId = msg.id;
                console.log(`User keluar: ${leftClientId}`);
                if (peerConnections[leftClientId]) {
                    peerConnections[leftClientId].close();
                    delete peerConnections[leftClientId];
                }
                removeVideo(leftClientId);
                break;

            // Saat menerima "sinyal" (offer/answer/candidate) dari user lain
            case 'signal':
                handleSignalFromPeer(msg.from, msg.data);
                break;
        }
    }
    
    async function handleSignalFromPeer(clientId, signal) {
        const pc = peerConnections[clientId] || createPeerConnection(clientId);
        
        if (signal.type === 'offer') {
            await pc.setRemoteDescription(new RTCSessionDescription(signal));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            sendSignal(clientId, { type: 'answer', sdp: answer.sdp });
        } else if (signal.type === 'answer') {
            await pc.setRemoteDescription(new RTCSessionDescription(signal));
        } else if (signal.candidate) {
            try {
                await pc.addIceCandidate(new RTCIceCandidate(signal.candidate));
            } catch (err) {
                console.error("Error menambahkan ICE candidate:", err);
            }
        }
    }

    function createPeerConnection(clientId) {
        const pc = new RTCPeerConnection(ICE_SERVERS);
        peerConnections[clientId] = pc;

        // Kirim stream video kita ke user lain saat koneksi terbentuk
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        // Saat menerima stream video DARI user lain
        pc.ontrack = (event) => {
            displayVideo(clientId, event.streams[0]);
        };
        
        // Kirim "alamat jaringan" (ICE candidate) ke user lain
        pc.onicecandidate = (event) => {
            if (event.candidate) {
                sendSignal(clientId, { candidate: event.candidate });
            }
        };

        return pc;
    }

    function sendSignal(to, data) {
        signalingSocket.send(JSON.stringify({ action: 'signal', to, from: myClientId, data }));
    }

    // === FUNGSI TAMPILAN (UI) ===

    function displayVideo(clientId, stream) {
        if (document.getElementById(`video-container-${clientId}`)) return;

        const container = document.createElement('div');
        container.id = `video-container-${clientId}`;
        container.className = 'video-container';
        
        const video = document.createElement('video');
        video.srcObject = stream;
        video.autoplay = true;
        video.playsInline = true;

        const nameTag = document.createElement('p');
        nameTag.className = 'participant-name';
        nameTag.textContent = clientId === 'Anda (Lokal)' ? 'Anda' : `User ${clientId.substring(0, 6)}`;
        
        if (clientId === 'Anda (Lokal)') {
            video.muted = true; // Agar suara kita tidak bergema
        }

        container.appendChild(video);
        container.appendChild(nameTag);
        videoGrid.appendChild(container);
    }
    
    function removeVideo(clientId) {
        const container = document.getElementById(`video-container-${clientId}`);
        if (container) {
            container.remove();
        }
    }

</script>
</body>
</html>

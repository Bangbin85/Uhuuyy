<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Call Grup (via Spreadsheet)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; background-color: #2c3e50; color: white; min-height: 100vh; box-sizing: border-box; margin: 0; }
        .hidden { display: none; }
        #join-screen h1 { font-size: 2em; }
        #join-screen p { margin-bottom: 20px; }
        .room-input { padding: 10px; font-size: 1.2em; text-align: center; border: 2px solid #3498db; border-radius: 5px; margin-right: 10px; }
        #join-btn { padding: 10px 20px; font-size: 1.2em; cursor: pointer; background-color: #3498db; color: white; border: none; border-radius: 5px; }
        
        #call-screen h1 { margin-top: 0; }
        #video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; width: 100%; max-width: 1200px; flex-grow: 1; }
        video { width: 100%; height: auto; object-fit: cover; border: 3px solid #3498db; border-radius: 10px; background: #000; }
        .controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: center; background-color: #34495e; padding: 15px; border-radius: 10px; margin-top: 20px; position: sticky; bottom: 20px; z-index: 10; }
        button { padding: 8px 15px; border-radius: 5px; border: none; background-color: #3498db; color: white; cursor: pointer; font-weight: bold; }
        .control-btn { background-color: #2ecc71; width: 50px; height: 50px; border-radius: 50%; font-size: 20px; display: flex; align-items: center; justify-content: center; }
        .control-btn.disabled, #toggle-mic-btn.speaking { background-color: #e74c3c; }
        #exit-btn { background-color: #c0392b; }
        #room-info { background-color: #2c3e50; padding: 8px 15px; border-radius: 5px; }
    </style>
</head>
<body>

    <div id="join-screen">
        <h1>Video Call Grup</h1>
        <p>Masukkan ID Room untuk bergabung, atau biarkan kosong untuk membuat Room baru.</p>
        <div>
            <input type="text" id="room-id-input" class="room-input" placeholder="ID Room...">
            <button id="join-btn">Gabung</button>
        </div>
    </div>

    <div id="call-screen" class="hidden">
        <h1>Video Call Grup</h1>
        <div id="video-grid"></div>
        <div class="controls">
            <div id="room-info"></div>
            <button id="toggle-mic-btn" class="control-btn" title="Mute/Unmute Mic"><i class="fas fa-microphone"></i></button>
            <button id="toggle-cam-btn" class="control-btn" title="Turn On/Off Camera"><i class="fas fa-video"></i></button>
            <button id="exit-btn" class="control-btn" title="Keluar Panggilan"><i class="fas fa-phone-slash"></i></button>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
        // ######################################################################
        // ## PASTE URL APLIKASI WEB ANDA DARI GOOGLE APPS SCRIPT DI SINI! ##
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxZjswTzQBSlzdOtnbHYCp1LfltI9gO8WHaF9cVk6Sa_PSPvRX12-mbdYVg8dSOVjokiA/exec";
        // ######################################################################


        const joinScreen = document.getElementById('join-screen');
        const callScreen = document.getElementById('call-screen');
        const joinBtn = document.getElementById('join-btn');
        const roomIdInput = document.getElementById('room-id-input');
        const videoGrid = document.getElementById('video-grid');
        const roomInfo = document.getElementById('room-info');
        
        let myPeer, myStream, roomId;
        const peers = {};
        let pollingInterval;
        const POLLING_RATE_MS = 5000; // Bertanya ke server setiap 5 detik

        // Saat tombol Gabung diklik
        joinBtn.addEventListener('click', () => {
            roomId = roomIdInput.value.trim();
            if (roomId === "") {
                // Buat room ID acak jika kosong
                roomId = Math.random().toString(36).substring(2, 9);
            }
            
            joinScreen.classList.add('hidden');
            callScreen.classList.remove('hidden');
            roomInfo.innerHTML = `<strong>Room:</strong> ${roomId} <button onclick="copyRoomId()">Copy ID</button>`;
            
            startCall();
        });
        
        function copyRoomId() {
            navigator.clipboard.writeText(roomId);
            alert("Room ID disalin!");
        }

        function startCall() {
            myPeer = new Peer(undefined, {
                host: '0.peerjs.com', port: 443, path: '/', secure: true
            });

            myPeer.on('open', peerId => {
                navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(stream => {
                    myStream = stream;
                    addVideoStream(myStream, true); // Tambahkan video sendiri, 'true' untuk muted

                    // Mulai proses signaling
                    pollingInterval = setInterval(() => signalToServer(peerId), POLLING_RATE_MS);
                    signalToServer(peerId); // Panggil sekali di awal

                    // Menjawab panggilan masuk
                    myPeer.on('call', call => {
                        call.answer(myStream);
                        call.on('stream', userVideoStream => {
                            if (!peers[call.peer]) {
                                addVideoStream(userVideoStream);
                                peers[call.peer] = call;
                            }
                        });
                        call.on('close', () => {
                            removeVideoStream(call.peer);
                        });
                    });

                }).catch(err => console.error("Gagal mengakses media:", err));
            });
        }
        
        // Fungsi utama untuk komunikasi dengan "server" Spreadsheet
        async function signalToServer(peerId) {
            // 1. Daftarkan diri kita ke server (POST)
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // Penting untuk Apps Script Web App
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ room: roomId, peerId: peerId })
            });

            // 2. Minta daftar teman di room (GET)
            const response = await fetch(`${SCRIPT_URL}?room=${roomId}&peerId=${peerId}`);
            const otherPeers = await response.json();
            
            // 3. Panggil teman baru yang belum ada di daftar kita
            otherPeers.forEach(otherPeerId => {
                if (!peers[otherPeerId]) {
                    connectToNewUser(otherPeerId, myStream);
                }
            });

            // 4. (Opsional) Hapus teman yang sudah tidak ada di daftar server
            Object.keys(peers).forEach(connectedPeerId => {
                if (!otherPeers.includes(connectedPeerId)) {
                    peers[connectedPeerId].close();
                    removeVideoStream(connectedPeerId);
                }
            });
        }

        function connectToNewUser(userId, stream) {
            const call = myPeer.call(userId, stream);
            call.on('stream', userVideoStream => {
                if (!peers[call.peer]) { // Cek lagi untuk menghindari duplikat
                    addVideoStream(userVideoStream);
                    peers[call.peer] = call;
                }
            });
            call.on('close', () => {
                removeVideoStream(call.peer);
            });
            peers[userId] = call;
        }

        function addVideoStream(stream, isMuted = false) {
            const video = document.createElement('video');
            video.srcObject = stream;
            video.muted = isMuted;
            video.addEventListener('loadedmetadata', () => video.play());
            video.dataset.peerId = isMuted ? 'local' : stream.id; // Tandai video
            videoGrid.append(video);
        }

        function removeVideoStream(peerId) {
            if (peers[peerId]) {
                const videoElements = document.querySelectorAll('video');
                videoElements.forEach(video => {
                    // Cari video yang sesuai (ini asumsi sederhana)
                    if (video.srcObject.id === peers[peerId].remoteStream.id) {
                        video.remove();
                    }
                });
                delete peers[peerId];
            }
        }
        
        // --- Kontrol Tombol ---
        document.getElementById('toggle-mic-btn').addEventListener('click', () => {
            const audioTrack = myStream.getAudioTracks()[0];
            audioTrack.enabled = !audioTrack.enabled;
            // Style update (opsional)
        });
        document.getElementById('toggle-cam-btn').addEventListener('click', () => {
            const videoTrack = myStream.getVideoTracks()[0];
            videoTrack.enabled = !videoTrack.enabled;
            // Style update (opsional)
        });
        document.getElementById('exit-btn').addEventListener('click', () => {
            clearInterval(pollingInterval);
            if (myStream) myStream.getTracks().forEach(track => track.stop());
            if (myPeer) myPeer.destroy();
            window.location.reload();
        });

    </script>
</body>
</html>
